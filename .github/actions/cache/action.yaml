name: 'Compute cache keys'
description: 'Export cache keys for the build process to env vars'

runs:
  using: "composite"
  steps:
    - name: Get cache keys
      shell: bash
      run: |
        set -e

        # Should be the same command as the one in .github/workflows/ci.yml
        cache_dirname_main=$(tests/bin/compile-get-cache-key phar-location-is-not-used-in-cache-key --php-extensions=mbstring,phar,posix,tokenizer,pcntl)
        cache_key_main=$(basename $cache_dirname_main)
        echo cache_dirname_main=$cache_dirname_main >> $GITHUB_ENV
        echo cache_key_main=$cache_key_main >> $GITHUB_ENV

        # And should be the same command as the one in CompileCommandTest
        cache_dirname_test=$(tests/bin/compile-get-cache-key phar-location-is-not-used-in-cache-key --os linux --php-extensions mbstring,phar,posix,tokenizer)
        cache_key_test=$(basename $cache_dirname_test)
        echo cache_dirname_test=$cache_dirname_test >> $GITHUB_ENV
        echo cache_key_test=$cache_key_test >> $GITHUB_ENV

    - name: Restore PHP static building artifacts cache for main job
      uses: actions/cache@v4
      with:
        path: ${{ env.cache_dirname_main }}
        key: php-static-${{ env.cache_key_main }}
      if: matrix.castor.method == 'static'

    - name: Restore PHP static building artifacts cache for test job
      uses: actions/cache@v4
      with:
        path: ${{ env.cache_dirname_test }}
        key: php-static-${{ env.cache_key_test }}
